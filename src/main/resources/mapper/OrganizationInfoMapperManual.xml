<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xwkj.ygjces.Mapper.OrganizationInfoMapperManual" >
  <resultMap id="BaseResultMap" type="com.xwkj.ygjces.model.OrganizationInfo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jul 09 16:22:23 CST 2019.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="name" property="name" jdbcType="VARCHAR" />
    <result column="p_id" property="pId" jdbcType="BIGINT" />
    <result column="isEnablez" property="isenablez" jdbcType="INTEGER" />
  </resultMap>
  <resultMap id="ManualResultMap" type="com.xwkj.ygjces.model.UserOrgIntermediate">
    <result column="id" property="id" jdbcType="BIGINT" />
    <result column="userId" property="userId" jdbcType="BIGINT" />
    <result column="orgId" property="orgId" jdbcType="BIGINT" />
    <result column="name" property="name" jdbcType="VARCHAR" />
  </resultMap>
  <resultMap id="ManualResultMap2" type="com.xwkj.ygjces.model.OrgItemIntermediate">
    <result column="id" property="id" jdbcType="BIGINT" />
    <result column="org_id" property="orgId" jdbcType="BIGINT" />
    <result column="item_id" property="itemId" jdbcType="VARCHAR" />
    <result column="item_name" property="itemName" jdbcType="VARCHAR" />
  </resultMap>
  <resultMap id="ManualResultMap3" type="com.xwkj.ygjces.model.Achievements">
    <result column="id" property="id" jdbcType="BIGINT" />
    <result column="orgName" property="orgName" jdbcType="VARCHAR" />

  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Jul 09 22:33:55 CST 2019.
    -->
    id, name, p_id, isEnablez
  </sql>
  <select id="getOrganizationInfoList" resultMap="BaseResultMap">
    SELECT
    <include refid="Base_Column_List" />
    FROM tbl_gb_organization_info
    WHERE isEnablez = 1
  </select>

  <select id="getOrganizationInfoById" resultMap="BaseResultMap">
    SELECT
    <include refid="Base_Column_List" />
    FROM tbl_gb_organization_info
    WHERE id = #{id}
  </select>

  <select id="getTheLastOneOrganization" resultMap="BaseResultMap">
    SELECT *
    FROM tbl_gb_organization_info
    WHERE id = (SELECT max(id) FROM tbl_gb_organization_info)
  </select>

  <select id="getInfoFromUserAndOrganizationRelatedByID" resultMap="BaseResultMap">
    SELECT * FROM tbl_gb_organization_info o
    INNER JOIN tbl_gb_user_organziation_related uo ON o.id = uo.orgId
    INNER JOIN tbl_gb_user_info u ON uo.userId=u.pid
    WHERE o.id=#{id} AND u.isEnable = 1
  </select>

  <select id="getOrganizationInfoByUid" resultMap="BaseResultMap">
    SELECT * FROM tbl_gb_organization_info o
    INNER JOIN tbl_gb_user_organziation_related uo ON o.id = uo.orgId
    INNER JOIN tbl_gb_user_info u ON uo.userId=u.pid
    WHERE u.pid=#{id} AND u.isEnable = 1
  </select>

  <select id="getMaxPrimaryKey" resultType="java.lang.Long">
    SELECT MAX(id) from tbl_gb_organization_info
  </select>

  <update id="updatePrimaryKeyByKey">
    UPDATE tbl_gb_organization_info
    SET id = #{maxId}
    WHERE id = #{id}
  </update>

  <update id="updatePidByPrimaryKey">
    UPDATE tbl_gb_organization_info
    SET p_id = #{newId}
    WHERE p_id = #{oldId}
  </update>

  <select id="selectBigestPrimaryKeyLessThanBoundary" resultType="java.lang.Long">
    SELECT max(id)
    FROM tbl_gb_organization_info
    WHERE id <![CDATA[ < ]]> 1000000000
  </select>

  <insert id="addLeaderToOrganization">
    INSERT INTO tbl_gb_leader_organization_related(userId,orgId)
    VALUES (#{uId},#{oId})
  </insert>

  <delete id="removeLeaderFromOrganization">
    DELETE FROM tbl_gb_leader_organization_related
    WHERE userId=#{uId} AND orgId=#{oId}
  </delete>

  <select id="getLeaderInfoByUserId" resultMap="ManualResultMap">
    SELECT lor.id id,lor.userId userId,lor.orgId orgId,o.name name
    FROM tbl_gb_leader_organization_related lor
    LEFT JOIN tbl_gb_organization_info o on lor.orgId = o.id
    WHERE lor.userId = #{id}
  </select>

  <select id="getLeaderInfoByUserIdAndOrgId" resultMap="ManualResultMap">
    SELECT *
    FROM tbl_gb_leader_organization_related
    WHERE userId = #{uId} AND orgId = #{oId}
  </select>

  <insert id="insertOrgAndItemBindingInfo">
    INSERT INTO tbl_gb_organization_item_related(org_id,item_id,item_name)
    VALUES(#{orgId,jdbcType=BIGINT},#{itemId,jdbcType=VARCHAR},#{itemName,jdbcType=VARCHAR})
  </insert>

  <select id="getItemsThatBoundToTheOrgById" resultMap="ManualResultMap2">
    SELECT *
    FROM tbl_gb_organization_item_related
    WHERE org_id = #{orgId}
  </select>

  <delete id="unboundOrgAndItems">
    DELETE FROM tbl_gb_organization_item_related WHERE org_id = #{orgId} AND item_id = #{itemId}
  </delete>
  
  <select id="getOrgThatBoundToItems" resultMap="ManualResultMap3">
    SELECT DISTINCT b.id id,b.name orgName FROM tbl_gb_organization_item_related a
    INNER JOIN tbl_gb_organization_info b on a.org_id = b.id
    <if test="orgName != null and orgName != ''" >
      WHERE b.name LIKE CONCAT('%',#{orgName},'%')
    </if>
  </select>
  
  <select id="getTrueNameByOrgId" resultType="java.lang.String">
    SELECT b.trueName FROM tbl_gb_user_organziation_related a
    INNER JOIN tbl_gb_user_info b on a.userId = b.pid
    WHERE a.orgId = #{orgId}
  </select>

  <select id="getLeaderByOrgId" resultType="java.lang.String">
    SELECT b.trueName FROM tbl_gb_leader_organization_related a
    INNER JOIN tbl_gb_user_info b on a.userId = b.pid
    WHERE a.orgId = #{orgId}
  </select>

  <select id="getItemsByOrgId" resultMap="ManualResultMap2">
    SELECT *
    FROM tbl_gb_organization_item_related
    WHERE org_id = #{orgId}
  </select>

  <select id="getOrganizationInfoThatHasSubOrganization" resultMap="BaseResultMap">
    SELECT DISTINCT a.id,a.name,a.p_id FROM tbl_gb_organization_info a
    INNER JOIN tbl_gb_organization_info b on a.id = b.p_id
    WHERE a.isEnablez = 1 and b.isEnablez = 1
  </select>

  <select id="getOrganizationInfoByPid" resultMap="BaseResultMap">
    SELECT *
    FROM tbl_gb_organization_info
    WHERE p_id = #{pId}
  </select>

  <delete id="deleteAllOrgFromLeaderById">
    DELETE FROM tbl_gb_leader_organization_related WHERE userId = #{id}
  </delete>

  <select id="getOrgIdsListByUserId" resultType="java.lang.Long">
    SELECT orgId FROM tbl_gb_user_organziation_related WHERE userId = #{userId} ORDER BY orgId DESC
  </select>

  <select id="getOrgIdsListByLeaderId" resultType="java.lang.Long">
    SELECT orgId FROM tbl_gb_leader_organization_related WHERE userId = #{id} ORDER BY orgId DESC
  </select>

  <select id="getLeaderAndOrgInfoByLeaderIdAndOrgId" resultType="java.lang.Long">
    SELECT id
    FROM tbl_gb_leader_organization_related
    WHERE userId = #{leaderId} AND orgId = #{orgId}
  </select>
  <select id="getLeaderIdByOrgId" resultType="java.lang.Long">
    SELECT userId FROM tbl_gb_leader_organization_related WHERE orgId = #{orgId}
  </select>

  <select id="getSubOrgIdsByPid" resultType="java.lang.Long">
    SELECT id FROM `tbl_gb_organization_info` WHERE p_id = #{id}
  </select>

  <select id="getOrganizationInfoByOrgName" resultMap="BaseResultMap">
    SELECT * FROM `tbl_gb_organization_info` WHERE `name` = #{name} and isEnablez = 1
  </select>

</mapper>